<%= form_with model: @price_update, local: true do |f| %>
  <% if @price_update.errors.any? %>
    <div class="alert alert-danger">
      <h6 class="alert-heading">Por favor corrige los siguientes errores:</h6>
      <ul class="mb-0">
        <% @price_update.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  
  <% if flash[:alert] %>
    <div class="alert alert-danger">
      <%= flash[:alert] %>
    </div>
  <% end %>
  
  <div class="row">
    <div class="col-md-12">
      <div class="mb-3">
        <%= f.label :product_presentation_id, "Producto / Presentación", class: "form-label fw-bold" %>
        <% 
          presentation_options = @product_presentations.flat_map do |p|
            p.product_presentations.active.map { |pp| [pp.full_name_with_product, pp.id] }
          end
        %>
        <%= f.select :product_presentation_id,
            options_for_select(presentation_options, @price_update.product_presentation_id),
            { prompt: "Selecciona un producto y presentación" },
            { class: "form-select", required: true } %>
        <small class="form-text text-muted">Selecciona el producto y su presentación a actualizar</small>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= f.label :new_price, "Nuevo Precio", class: "form-label fw-bold" %>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <%= f.number_field :new_price, 
              class: "form-control", 
              step: 0.01, 
              min: 0.01,
              required: true,
              placeholder: "0.00" %>
        </div>
        <small class="form-text text-muted">Ingresa el nuevo precio a aplicar</small>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-12">
      <div class="mb-3">
        <label class="form-label fw-bold">Asignar a:</label>
        <div class="form-check mb-2">
          <%= radio_button_tag :assignment_type, "visit", @price_update.visit_id.present?, 
              class: "form-check-input", 
              id: "assignment_visit",
              data: { toggle: "assignment" } %>
          <label class="form-check-label" for="assignment_visit">
            Visita específica
          </label>
        </div>
        <div class="form-check mb-3">
          <%= radio_button_tag :assignment_type, "store", @price_update.store_id.present? && @price_update.visit_id.blank?, 
              class: "form-check-input", 
              id: "assignment_store",
              data: { toggle: "assignment" } %>
          <label class="form-check-label" for="assignment_store">
            Tienda (todas las visitas futuras)
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row" id="visit_assignment" style="<%= 'display: none;' unless @price_update.visit_id.present? %>">
    <div class="col-md-12">
      <div class="mb-3">
        <%= f.label :visit_id, "Visita", class: "form-label fw-bold" %>
        <%= f.collection_select :visit_id, 
            @visits,
            :id,
            :visit_display_name,
            { prompt: "Selecciona una visita", include_blank: true },
            { class: "form-select" } %>
        <small class="form-text text-muted">La actualización solo aparecerá en esta visita específica</small>
      </div>
    </div>
  </div>
  
  <div class="row" id="store_assignment" style="<%= 'display: none;' unless (@price_update.store_id.present? && @price_update.visit_id.blank?) %>">
    <div class="col-md-12">
      <div class="mb-3">
        <%= f.label :store_id, "Tienda", class: "form-label fw-bold" %>
        <%= f.collection_select :store_id, 
            @stores,
            :id,
            :name,
            { prompt: "Selecciona una tienda", include_blank: true },
            { class: "form-select" } %>
        <small class="form-text text-muted">La actualización aparecerá en todas las visitas futuras a esta tienda hasta ser aplicada</small>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-12">
      <div class="mb-3">
        <%= f.label :notes, "Notas (opcional)", class: "form-label fw-bold" %>
        <%= f.text_area :notes, class: "form-control", rows: 3, placeholder: "Notas adicionales sobre esta actualización..." %>
      </div>
    </div>
  </div>
  
  <div class="d-flex justify-content-end gap-2">
    <%= link_to price_updates_path, class: "btn btn-secondary" do %>
      <i class="bi bi-x-circle me-2"></i> Cancelar
    <% end %>
    <%= f.submit (@price_update.new_record? ? "Crear Actualización" : "Actualizar"), class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const visitRadio = document.getElementById('assignment_visit');
    const storeRadio = document.getElementById('assignment_store');
    const visitAssignment = document.getElementById('visit_assignment');
    const storeAssignment = document.getElementById('store_assignment');
    const visitSelect = document.querySelector('#price_update_visit_id');
    const storeSelect = document.querySelector('#price_update_store_id');
    
    function toggleAssignments() {
      if (visitRadio.checked) {
        visitAssignment.style.display = 'block';
        storeAssignment.style.display = 'none';
        storeSelect.value = '';
      } else if (storeRadio.checked) {
        visitAssignment.style.display = 'none';
        storeAssignment.style.display = 'block';
        visitSelect.value = '';
      }
    }
    
    visitRadio.addEventListener('change', toggleAssignments);
    storeRadio.addEventListener('change', toggleAssignments);
    
    // Inicializar estado
    toggleAssignments();
  });
</script>
