<%# Barra de información / navegación (componente reutilizable) %>
<%= render 'shared/view_header', title: "Detalles del Plan Ejecutado" do %>
  <%= link_to work_plan_executions_path, class: "btn btn-secondary" do %>
    <i class="bi bi-arrow-left me-2"></i> Volver
  <% end %>
<% end %>

<%# Espacio vacío (componente reutilizable) %>
<div class="view-spacing"></div>

<% if @visit && @work_plan %>
  <%# Información de la visita %>
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Información de la Visita</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-2">
            <strong>Tienda:</strong> <%= @visit.store.name %>
          </p>
          <p class="mb-2">
            <strong>Cadena:</strong> <%= @visit.store.chain.name %>
          </p>
          <p class="mb-2">
            <strong>Formato:</strong> <%= @visit.store.format.name %>
          </p>
        </div>
        <div class="col-md-6">
          <p class="mb-2">
            <strong>Plan de Trabajo:</strong> <%= @work_plan.name %>
          </p>
          <p class="mb-2">
            <strong>Fecha de Visita:</strong> <%= @visit.scheduled_date.strftime("%d/%m/%Y") %>
          </p>
          <p class="mb-2">
            <strong>Fecha y Hora de Terminación:</strong> 
            <%= @visit.updated_at.strftime("%d/%m/%Y a las %H:%M") %>
          </p>
          <p class="mb-2">
            <strong>Promotor:</strong> <%= @visit.user.name %>
          </p>
        </div>
      </div>
    </div>
  </div>

  <%# Tareas ejecutadas con sus resultados %>
  <h5 class="mb-3">Tareas Ejecutadas</h5>
  <div class="row g-3">
    <% @responses.each_with_index do |response, index| %>
      <% task = response.work_plan_task.task %>
      <% work_plan_task = response.work_plan_task %>
      <% response_data = response.response_data || {} %>
      
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <span class="badge bg-primary me-2"><%= index + 1 %></span>
              <%= task.name %>
            </h6>
          </div>
          <div class="card-body">
            <%# Instrucciones de la tarea %>
            <% if work_plan_task.instructions.present? %>
              <div class="mb-3">
                <strong>Instrucciones:</strong>
                <p class="text-muted mb-0"><%= work_plan_task.instructions %></p>
              </div>
            <% end %>

            <%# Resultados según el tipo de tarea %>
            <div class="task-results">
              <% case task.task_type %>
              <% when 'comment_capture' %>
                <div>
                  <strong>Comentario:</strong>
                  <% if response_data['comment'].present? %>
                    <p class="mb-0 mt-2 p-3 bg-light rounded"><%= response_data['comment'] %></p>
                  <% else %>
                    <p class="text-muted mb-0 mt-2">Sin comentario</p>
                  <% end %>
                </div>

              <% when 'photo_capture' %>
                <div>
                  <strong>Fotografía Capturada:</strong>
                  <% if response.photo.attached? %>
                    <div class="mt-3">
                      <%= image_tag response.photo, class: "img-fluid rounded shadow-sm", style: "max-height: 400px; cursor: pointer;", onclick: "window.open(this.src, '_blank')" %>
                      <p class="text-muted small mt-2 mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Haz clic en la imagen para verla en tamaño completo
                      </p>
                    </div>
                  <% elsif response_data['photo_path'].present? %>
                    <p class="text-muted mb-2 mt-2">
                      <i class="bi bi-camera me-1"></i>
                      Foto guardada localmente: <%= response_data['photo_path'] %>
                    </p>
                    <p class="text-muted small">
                      <em>Nota: La foto aún no se ha sincronizado al servidor. Se mostrará cuando se complete la sincronización.</em>
                    </p>
                  <% else %>
                    <p class="text-muted mb-0 mt-2">No se capturó fotografía</p>
                  <% end %>
                </div>

              <% when 'inventory_capture' %>
                <div>
                  <strong>Inventario Capturado:</strong>
                  <% if response_data['inventory'].present? && response_data['inventory'].is_a?(Array) && response_data['inventory'].any? %>
                    <div class="table-responsive mt-2">
                      <table class="table table-sm table-bordered">
                        <thead class="table-light">
                          <tr>
                            <th>Producto</th>
                            <th>Presentación</th>
                            <th class="text-end">Cantidad</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% response_data['inventory'].each do |item| %>
                            <% if item.is_a?(Hash) %>
                              <% presentation_id = item['presentation_id'] %>
                              <% quantity = item['quantity'] %>
                              <% presentation = ProductPresentation.find_by(id: presentation_id) if presentation_id %>
                              <tr>
                                <td>
                                  <% if presentation %>
                                    <%= presentation.product.name %>
                                  <% else %>
                                    ID: <%= presentation_id %>
                                  <% end %>
                                </td>
                                <td>
                                  <% if presentation %>
                                    <%= presentation.full_name %>
                                  <% else %>
                                    N/A
                                  <% end %>
                                </td>
                                <td class="text-end"><strong><%= quantity %></strong></td>
                              </tr>
                            <% end %>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  <% else %>
                    <p class="text-muted mb-0 mt-2">No se capturó inventario</p>
                  <% end %>
                </div>

              <% when 'incident_report' %>
                <div>
                  <% if response_data['description'].present? %>
                    <div class="mb-3">
                      <strong>Descripción del Incidente:</strong>
                      <p class="mb-0 mt-2 p-3 bg-light rounded"><%= response_data['description'] %></p>
                    </div>
                  <% end %>
                  <% if response.photo.attached? %>
                    <div>
                      <strong>Fotografía del Incidente:</strong>
                      <div class="mt-3">
                        <%= image_tag response.photo, class: "img-fluid rounded shadow-sm", style: "max-height: 400px; cursor: pointer;", onclick: "window.open(this.src, '_blank')" %>
                        <p class="text-muted small mt-2 mb-0">
                          <i class="bi bi-info-circle me-1"></i>
                          Haz clic en la imagen para verla en tamaño completo
                        </p>
                      </div>
                    </div>
                  <% elsif response_data['photo_path'].present? %>
                    <div>
                      <strong>Fotografía del Incidente:</strong>
                      <p class="text-muted mb-2 mt-2">
                        <i class="bi bi-camera me-1"></i>
                        Foto guardada localmente: <%= response_data['photo_path'] %>
                      </p>
                      <p class="text-muted small">
                        <em>Nota: La foto aún no se ha sincronizado al servidor. Se mostrará cuando se complete la sincronización.</em>
                      </p>
                    </div>
                  <% end %>
                  <% if response_data['description'].blank? && !response.photo.attached? && response_data['photo_path'].blank? %>
                    <p class="text-muted mb-0">No se registró información del incidente</p>
                  <% end %>
                </div>

              <% when 'image_display' %>
                <div>
                  <strong>Estado:</strong>
                  <p class="text-muted mb-0 mt-2">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    Imagen visualizada correctamente
                  </p>
                  <% if work_plan_task.image.attached? %>
                    <div class="mt-3">
                      <strong>Imagen Mostrada:</strong>
                      <div class="mt-2">
                        <%= image_tag work_plan_task.image, class: "img-fluid rounded", style: "max-height: 300px;" %>
                      </div>
                    </div>
                  <% end %>
                </div>

              <% else %>
                <div>
                  <strong>Datos de Respuesta:</strong>
                  <pre class="bg-light p-3 rounded mt-2" style="max-height: 200px; overflow-y: auto;"><%= JSON.pretty_generate(response_data) %></pre>
                </div>
              <% end %>
            </div>

            <%# Fecha de captura %>
            <div class="mt-3 pt-3 border-top">
              <small class="text-muted">
                <i class="bi bi-clock me-1"></i>
                Capturado: <%= response.updated_at.strftime("%d/%m/%Y a las %H:%M") %>
              </small>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="alert alert-warning">
    No se encontró información de la visita o el plan de trabajo.
  </div>
<% end %>
