<%# Barra de información / navegación (componente reutilizable) %>
<%= render 'shared/view_header', title: (@route.persisted? ? "Editar Ruta" : "Nueva Ruta") do %>
  <button type="submit" form="route-form" class="btn btn-primary">
    <i class="bi bi-check-circle me-2"></i> Guardar
  </button>
  <%= link_to routes_path, class: "btn btn-secondary" do %>
    <i class="bi bi-x-circle me-2"></i> Cancelar
  <% end %>
<% end %>

<%# Espacio vacío (componente reutilizable) %>
<div class="view-spacing"></div>

<%# Formulario de ruta %>
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <%= form_with model: @route, url: (@route.persisted? ? route_path(@route) : routes_path), 
            method: (@route.persisted? ? :patch : :post),
            local: true,
            id: "route-form" do |f| %>
          
          <% if @route.errors.any? %>
            <div class="alert alert-danger">
              <h6 class="alert-heading">Por favor corrige los siguientes errores:</h6>
              <ul class="mb-0">
                <% @route.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <% if flash[:alert] %>
            <div class="alert alert-danger">
              <%= flash[:alert] %>
            </div>
          <% end %>
          
          <div class="mb-3">
            <%= f.label :name, "Nombre", class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true, autofocus: true %>
          </div>
          
          <div class="mb-3">
            <%= f.label :comments, "Comentarios", class: "form-label" %>
            <%= f.text_area :comments, class: "form-control", rows: 4, placeholder: "Notas adicionales sobre la ruta..." %>
          </div>
          
          <hr class="my-4">
          
          <h6 class="mb-3">Tiendas Asignadas</h6>
          
          <div class="mb-3">
            <label class="form-label">Selecciona las tiendas que pertenecen a esta ruta</label>
            <small class="form-text text-muted d-block mb-2">Una tienda solo puede pertenecer a una ruta. Si seleccionas una tienda que ya tiene ruta, se moverá a esta ruta.</small>
            
            <% if @stores.any? %>
              <div class="mb-3">
                <input type="text" 
                       id="store-search" 
                       class="form-control" 
                       placeholder="Buscar tienda por nombre..." 
                       autocomplete="off">
              </div>
              
              <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;" id="stores-container">
                <% @stores.each do |store| %>
                  <div class="form-check store-item" data-store-name="<%= store.name.downcase %>" data-store-chain="<%= store.chain.name.downcase %>">
                    <%= check_box_tag "route[store_ids][]", store.id, 
                        @selected_store_ids.include?(store.id),
                        id: "store_#{store.id}",
                        class: "form-check-input" %>
                    <%= label_tag "store_#{store.id}", 
                        "#{store.name} (#{store.chain.name})#{' - Ya tiene ruta: ' + store.route.name if store.route && store.route != @route}", 
                        class: "form-check-label" %>
                  </div>
                <% end %>
              </div>
              
              <div id="no-results" class="alert alert-info d-none mt-2">
                <i class="bi bi-info-circle me-2"></i>No se encontraron tiendas que coincidan con la búsqueda.
              </div>
            <% else %>
              <div class="border rounded p-3">
                <p class="text-muted mb-0">No hay tiendas disponibles. Crea tiendas primero.</p>
              </div>
            <% end %>
          </div>
          
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const searchInput = document.getElementById('store-search');
              const storesContainer = document.getElementById('stores-container');
              const noResults = document.getElementById('no-results');
              
              if (searchInput && storesContainer) {
                searchInput.addEventListener('input', function() {
                  const searchTerm = this.value.toLowerCase().trim();
                  const storeItems = storesContainer.querySelectorAll('.store-item');
                  let visibleCount = 0;
                  
                  storeItems.forEach(function(item) {
                    const storeName = item.dataset.storeName || '';
                    const storeChain = item.dataset.storeChain || '';
                    const matches = storeName.includes(searchTerm) || storeChain.includes(searchTerm);
                    
                    if (matches || searchTerm === '') {
                      item.style.display = 'block';
                      visibleCount++;
                    } else {
                      item.style.display = 'none';
                    }
                  });
                  
                  // Mostrar/ocultar mensaje de "no hay resultados"
                  if (noResults) {
                    if (visibleCount === 0 && searchTerm !== '') {
                      noResults.classList.remove('d-none');
                      storesContainer.style.display = 'none';
                    } else {
                      noResults.classList.add('d-none');
                      storesContainer.style.display = 'block';
                    }
                  }
                });
              }
            });
          </script>
        <% end %>
      </div>
    </div>
  </div>
</div>
